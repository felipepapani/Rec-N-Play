<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro Completo de Atividade</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; }
    form { display: grid; gap: 1rem; }
    label { display: flex; flex-direction: column; }
    input, textarea, select, button { padding: .4rem; font-size: 1rem; }
    button { width: fit-content; cursor: pointer; }
    .char-counter { font-size: .9rem; color: #666; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>Nova Atividade</h1>
  <form id="activityForm">

    <label>
      Nome da Atividade:
      <input type="text" id="text_mkqrhjas" required>
    </label>

    <label>
      Formato de Atividade:
      <select id="short_textossh5v4j" required>
        <option value="">-- selecione --</option>
        <option>Apresentação artística</option>
        <option>Apresentação de trabalhos</option>
        <option>Atendimentos</option>
        <option>Campeonato</option>
        <option>Contação de História</option>
        <option>Cortejo</option>
        <option>Demonstração</option>
        <option>Desfile de moda</option>
        <option>Exibição audiovisual</option>
        <option>Experiência</option>
        <option>Exposição artística</option>
        <option>Feira</option>
        <option>Hackathon</option>
        <option>Intervenção urbana</option>
        <option>Mentoria</option>
        <option>Mesa redonda</option>
        <option>Minicurso</option>
        <option>Oficina</option>
        <option>Palestra</option>
        <option>Pitchs</option>
        <option>Revisão de portfólio</option>
        <option>Roda de conversa</option>
        <option>Rodada de negócios</option>
        <option>Show</option>
        <option>Talk Show</option>
        <option>Visitas/ percursos guiados</option>
        <option>Workshop</option>
      </select>
    </label>

    <label id="daysLabel" class="hidden">
      Dias (1 a 4):
      <select id="short_textb7obn15q">
        <option value="">-- selecione --</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
      </select>
    </label>

    <label>
      Duração:
      <input type="text" id="text_mkqrvnnp">
    </label>

    <label>
      Descrição:
      <textarea id="long_text_mkqr5e1x" rows="3" maxlength="700"></textarea>
      <div class="char-counter" id="descCounter">0/700</div>
    </label>

    <label>
      Tema Principal:
      <div id="temaPrincipalTree"></div>
      <input type="hidden" id="temaPrincipalValue" name="temaPrincipalValue">
    </label>

    <label>
      Tema Secundário:
      <div id="temaSecundarioTree"></div>
      <input type="hidden" id="temaSecundarioValue" name="temaSecundarioValue">
    </label>

    

    <label>
      público:
      <select id="text_mkqr6nqa">
        <option value="">-- selecione --</option>
        <option>especialista no tema</option>
        <option>geral</option>
        <option>negócios</option>
        <option>infantil</option>
        <option>adolescentes</option>
        <option>apenas mulheres</option>
      </select>
    </label>

    <label id="maxGuestsLabel" class="hidden">
      max público:
      <select id="text_mkqrjadb">
        <option value="">-- selecione --</option>
        <option value="10">10</option>
        <option value="15">15</option>
        <option value="20">20</option>
        <option value="25">25</option>
        <option value="30">30</option>
        <option value="35">35</option>
        <option value="40">40</option>
        <option value="45">45</option>
        <option value="50">50</option>
        <option value="Sem restrição">Sem restrição</option>
      </select>
    </label>

     <!-- Restrição de faixa etária -->
     <label>
        Restrição de faixa etária:
        <select id="text_mkqrrpq3" required>
          <option value="">-- selecione --</option>
          <option value="Não">Não</option>
          <option value="Sim">Sim</option>
        </select>
      </label>
      <label id="ageRangeLabel" class="hidden">
        Informe a faixa etária (text_mkqrrpq3_range):
        <input type="text" id="text_mkqrrpq3_range" placeholder="ex: 18-25">
      </label>
  

    <label>
      Informações extras:
      <textarea id="text_mkqrqmfw" rows="2" maxlength="700"></textarea>
      <div class="char-counter" id="extrasCounter">0/700</div>
    </label>

   
     <label>Convidados:</label>
    <div class="guest-slots" id="guestSlots">
      <!-- aqui serão adicionados até 6 .guest-slot -->
    </div>

    <button type="submit">Criar Atividade</button>
  </form>
  


    <div id="guestModal" class="modal hidden">
      <div class="content">
        <h3>Novo Convidado</h3>
        <input id="guestNameInput" placeholder="Nome" />
        <input id="guestCargoInput" placeholder="Cargo" />
        <input id="guestEmpresaInput" placeholder="Empresa" />
        <button id="saveGuestBtn" type="button">Salvar convidado</button>
        <button id="closeGuestModal" type="button">Fechar</button>
      </div>
    </div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // ————— Configurações gerais —————
  const API_URL        = 'https://plain-butterfly-7001.programacao-e50.workers.dev';
  const BOARD_ID       = 9099133664;
  const GUEST_BOARD_ID = 9102764459;

  // ————— Estado global —————
  let selectedGuests = [];
  let guestsToCreate = [];

  // ————— Função GraphQL genérica —————
  async function mondayMutation(query) {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query })
    });
    const j = await res.json();
    if (!res.ok) throw j.errors || j;
    if (j.errors) throw j.errors;
    return j.data;
  }

  // ————— Renderiza slots de convidados + botão “+” —————
  function renderSlots() {
    const c = document.getElementById('guestSlots');
    if (!c) return;
    c.innerHTML = '';
    selectedGuests.forEach((g,i) => {
      const d = document.createElement('div');
      d.className = 'guest-slot';
      d.textContent = g.name;
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'remove';
      btn.innerHTML = '&times;';
      btn.onclick = () => { selectedGuests.splice(i,1); renderSlots(); };
      d.appendChild(btn);
      c.appendChild(d);
    });
    if (selectedGuests.length < 6) {
      const b = document.createElement('button');
      b.type = 'button'; b.id = 'addGuestBtn'; b.textContent = '+';
      b.onclick = openGuestModal;
      c.appendChild(b);
    }
  }

  // ————— Modal de “Novo Convidado” —————
  function openGuestModal() {
    const m = document.getElementById('guestModal');
    if (!m) return;
    m.classList.remove('hidden');
    ['guestNameInput','guestCargoInput','guestEmpresaInput'].forEach(id=>{
      const inp = document.getElementById(id);
      if (inp) inp.value = '';
    });
  }
  function closeGuestModal() {
    const m = document.getElementById('guestModal');
    if (m) m.classList.add('hidden');
  }

  const closeBtn = document.getElementById('closeGuestModal');
  if (closeBtn) closeBtn.onclick = closeGuestModal;

  const saveBtn = document.getElementById('saveGuestBtn');
  if (saveBtn) saveBtn.onclick = () => {
    const nameEl    = document.getElementById('guestNameInput');
    const cargoEl   = document.getElementById('guestCargoInput');
    const empresaEl = document.getElementById('guestEmpresaInput');
    const name      = nameEl?.value.trim()    || '';
    const cargo     = cargoEl?.value.trim()   || '';
    const empresa   = empresaEl?.value.trim() || '';
    if (!name) {
      alert('Informe ao menos o nome do convidado.');
      return;
    }
    const guest = { id: null, name, cargo, empresa };
    selectedGuests.push(guest);
    guestsToCreate.push(guest);
    closeGuestModal();
    renderSlots();
  };

  // ————— Subtemas por tema —————
  const subtemasPorTema = {
    "Artes e Cultura": ["Arquitetura","Artes Visuais","Audiovisual","Circo","Cultura Maker","Cultura Popular","Dança","Fotografia","Gastronomia","HQ","Intervenções Urbanas","Literatura","Moda","Música","Patrimônio Imaterial","Teatro"],
    "Comunicação": ["Comunicação","Creator","Criação de Conteúdo","Design Gráfico/Industrial","Podcast"],
    "Dados e Segurança Digital": ["Análise de Dados","Blockchain","Cibersegurança","Governança de Dados","Investimentos/Criptomoedas","LGPD","NFT","Privacidade","Web3"],
    "Desenvolvimento de Software e Cloud": ["Desenvolvimento de Software e Cloud","Low Code/No Code","Programação de Software"],
    "Diversidade e Inclusão": ["50+","Acessibilidade/PCD","Equidade Racial","LGBTQIAPN+","Mulheres","Neurodivergência","Periferias"],
    "Empreendedorismo e Inovação": ["Ecossistemas de Inovação","Empresa Júnior","Gestão de Comunidades","Inovação Aberta","Internacionalização","Startup","Transformação Digital"],
    "Games e Design": ["Desenvolvimento de Jogos","e-Sports","Experiência do Usuário (UX/CX)","Gameficação","Interface do Usuário (UI)"],
    "Gente e Gestão": ["Carreira Profissional","Cultura Organizacional","Desenvolvimento de Times","Formação","RH","Softskills"],
    "Governança": ["ESG","Governança de Dados","Impacto Social","Legislação","Responsabilidade Social"],
    "Inteligência Artificial, Tecnologias Imersivas e Metaverso": ["Realidade Virtual","Deep Learning","Engenharia de Prompt","Inteligência Artificial","LLM","Machine Learning","Metaverso","Processamento de Linguagem Natural","Realidade Aumentada/Realidade Mista","Visão Computacional"],
    "Investimentos": ["Captação de Recursos","Investimento em Inovação","Criptomoedas"],
    "Política e Cidadania": ["Cidadania Digital","Direito","Educação","Empregabilidade","Geopolítica","Infância","Mobilidade Urbana","Saúde","Turismo","Urbanismo"],
    "Processos e Técnicas de Mercado": ["Agilidade","Atacado e Varejo","Branding","Canais de Venda","Comportamento do Consumidor","E-commerce","Experiência do Cliente","Marketing","Vendas B2B/B2C"],
    "Setores Tech": ["Agritech","Cleantech","Construtech","Ecotech","Edutech","Fintech","Foodtech","Govtech","Healthtech","Lawtech","Retailtech","Sportech"],
    "Simulação e Modelagem": ["Corte a Laser","Impressão 3D","Modelagem 3D"],
    "Sustentabilidade": ["Desenvolvimento Sustentável","Economia Circular","Eficiência Energética","Energia Renovável","Gestão de Resíduos","Logística Reversa","Meio Ambiente","Mudanças Climáticas","ODS"],
    "Tecnologias de Conectividade, Robótica e Computação Avançada": ["5G","6G","Computação Quântica","IoT","Robótica","Sistemas Embarcados"]
  };

  // ————— Constrói árvore Tema→Subtema —————
  function buildTree(containerId, hiddenInputId) {
    const container = document.getElementById(containerId);
    const hidden    = document.getElementById(hiddenInputId);
    if (!container || !hidden) return;
    container.innerHTML = '';
    Object.entries(subtemasPorTema).forEach(([tema, subs]) => {
      const det = document.createElement('details');
      const sum = document.createElement('summary');
      sum.textContent = tema;
      det.appendChild(sum);
      subs.forEach(sub => {
        const div = document.createElement('div');
        div.className = 'subtema-item';
        div.textContent = sub;
        div.onclick = () => {
          hidden.value = `${tema} → ${sub}`;
          container.querySelectorAll('.subtema-item').forEach(el => el.style.fontWeight = '');
          div.style.fontWeight = 'bold';
        };
        det.appendChild(div);
      });
      container.appendChild(det);
    });
  }

  // ————— Inicializa árvores —————
  buildTree('temaPrincipalTree','temaPrincipalValue');
  buildTree('temaSecundarioTree','temaSecundarioValue');

  // ————— Contadores de caracteres —————
  const descTA   = document.getElementById('long_text_mkqr5e1x');
  const extraTA  = document.getElementById('text_mkqrqmfw');
  if (descTA) descTA.addEventListener('input', e => {
    document.getElementById('descCounter').textContent = `${e.target.value.length}/700`;
  });
  if (extraTA) extraTA.addEventListener('input', e => {
    document.getElementById('extrasCounter').textContent = `${e.target.value.length}/700`;
  });

  // ————— Toggle de campos dinâmicos —————
  const formatSelect = document.getElementById('short_textossh5v4j');
  const daysLabel    = document.getElementById('daysLabel');
  const maxLabel     = document.getElementById('maxGuestsLabel');
  const restrSelect  = document.getElementById('text_mkqrrpq3');
  const ageLabel     = document.getElementById('ageRangeLabel');
  const showDays     = new Set(['Atendimentos','Mentoria','Pitchs','Rodada de negócios','Oficina','Minicurso','Hackathon','Intervenção urbana','Demonstração','Experiência','Visitas/ percursos guiados','Campeonato','Exposição artística','Feira']);
  const showMax      = new Set(['Mentoria','Pitchs','Revisão de portfólio','Rodada de negócios']);

  if (formatSelect && daysLabel && maxLabel) {
    formatSelect.addEventListener('change', () => {
      daysLabel.classList.toggle('hidden', !showDays.has(formatSelect.value));
      maxLabel .classList.toggle('hidden', !showMax.has(formatSelect.value));
    });
    formatSelect.dispatchEvent(new Event('change'));
  }
  if (restrSelect && ageLabel) {
    restrSelect.addEventListener('change', () => {
      ageLabel.classList.toggle('hidden', restrSelect.value !== 'Sim');
    });
    restrSelect.dispatchEvent(new Event('change'));
  }

  // ————— Submissão do formulário —————
  const form = document.getElementById('activityForm');
  if (form) form.addEventListener('submit', async e => {
    e.preventDefault();

    // 1) Cria convidados novos no Monday
    if (guestsToCreate.length) {
      const parts = guestsToCreate.map((g,i) => `
        m${i}: create_item(
          board_id: ${GUEST_BOARD_ID},
          item_name: "${g.name.replace(/"/g,'\\"')}",
          column_values: "{\\"text_mkqreer2\\":\\"${g.name.replace(/"/g,'\\"')}\\"${
            g.cargo   ? `,\\"text_mkqry55n\\":\\"${g.cargo.replace(/"/g,'\\"')}\\"` : ''
          }${
            g.empresa ? `,\\"text_mkqrghw1\\":\\"${g.empresa.replace(/"/g,'\\"')}\\"` : ''
          }}")`).join('\n');
      const batch = `mutation {${parts}}`;
      const res   = await mondayMutation(batch);
      guestsToCreate.forEach((g,i) => g.id = res[`m${i}`].id);
      guestsToCreate = [];
    }

    // 2) Captura valores do form
    const title  = document.getElementById('text_mkqrhjas').value;
    const titleEsc = title.replace(/"/g,'\\"');
    const days     = document.getElementById('short_textb7obn15q').value;
    const maxG     = document.getElementById('text_mkqrjadb').value;
    const duration = document.getElementById('text_mkqrvnnp').value;
    const desc     = descTA?.value || '';
    const extras   = extraTA?.value || '';
    const restr    = restrSelect?.value;
    const ageRange = document.getElementById('text_mkqrrpq3_range').value;
    const pub      = document.getElementById('text_mkqr6nqa').value;
    const guestIds = selectedGuests.map(g=>g.id);

    // 3) Separa tema/subtema
    const [temaP, subP=''] = (document.getElementById('temaPrincipalValue').value||'').split(' → ');
    const [temaS, subS=''] = (document.getElementById('temaSecundarioValue').value||'').split(' → ');

    // 4) Monta column_values
    const vals = {
      text_mkqrhjas:      title,
      short_textossh5v4j: formatSelect.value,
      ...(days   && { short_textb7obn15q: days   }),
      ...(maxG   && { text_mkqrjadb:      maxG   }),
      text_mkqrvnnp:      duration,
      long_text_mkqr5e1x: desc,
      text_mkqrqmfw:      extras,
      text_mkqrrpq3:      restr==='Sim'? ageRange: restr,
      text_mkqrwawz:      temaP,
      text_mkqrm18v:      subP,
      text_mkqrth67:      temaS,
      text_mkqrfjz3:      subS,
      text_mkqr6nqa:      pub,
      color_mkqr22e3:     { label: 'Caixa de Entrada' },
      ...(guestIds.length && {
        board_relation_mkqr6b1t: {
          linkedPulseIds: guestIds.map(id=>({ linkedPulseId:id }))
        }
      })
    };

    // 5) Escapa e envia
    const colJson = JSON.stringify(vals)
      .replace(/\\/g,'\\\\')
      .replace(/"/g,'\\"')
      .replace(/\n/g,'\\n');
    const mutation = `
      mutation {
        create_item(
          board_id: ${BOARD_ID},
          item_name: "${titleEsc}",
          column_values: "${colJson}"
        ) { id }
      }`;
    try {
      const resp = await mondayMutation(mutation);
      alert('Atividade criada! ID: ' + resp.create_item.id);
      form.reset();
      selectedGuests = [];
      renderSlots();
      buildTree('temaPrincipalTree','temaPrincipalValue');
      buildTree('temaSecundarioTree','temaSecundarioValue');
      formatSelect.dispatchEvent(new Event('change'));
      restrSelect.dispatchEvent(new Event('change'));
    } catch (err) {
      console.error(err);
      alert('Erro ao criar atividade. Veja o console.');
    }
  });

  // render pela primeira vez
  renderSlots();

}); // DOMContentLoaded
</script>

</body>
</html>
