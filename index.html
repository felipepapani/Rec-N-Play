<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro Completo de Atividade</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; }
    form { display: grid; gap: 1rem; }
    label { display: flex; flex-direction: column; }
    input, textarea, select, button { padding: .4rem; font-size: 1rem; }
    .char-counter { font-size: .9rem; color: #666; }
    .hidden { display: none; }
    .guest-slots { display: flex; flex-wrap: wrap; gap: .5rem; margin-top: .5rem; }
    .guest-slot { background: #8A2BE2; color: #fff; padding: .5rem 1rem; border-radius: 8px; display: flex; align-items: center; }
    .guest-slot .remove { background: transparent; border: none; color: #fff; margin-left: .5rem; cursor: pointer; }
    #addGuestBtn { background: #00FF7F; border: none; width: 2rem; height: 2rem; border-radius: 50%; font-size: 1.5rem; cursor: pointer; }
    .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; }
    .modal.hidden { display: none; }
    .modal .content { background: #fff; padding: 2rem; border-radius: 8px; width:90%; max-width:400px; }
    .modal .content input { width:100%; margin-bottom:1rem; }
  </style>
</head>
<body>
  <h1>Nova atividade</h1>
  <form id="activityForm">
    <label>
      Qual tipo de parceria:
      <select id="short_mkqwxtt2" required>
        <option value="">-- selecione --</option>
        <option>Parceiro de conteúdo</option>
        <option>Curador</option>
        <option>Realizador</option>
        <option>Patrocinador</option>
      </select>
    </label>

    <label id="labelEmpresa">
      Nome da Empresa
      <input type="text" id="text_mkqw6k20" required>
    </label>

    <label id="labelCNPJ">
      CNPJ:
      <input
        type="text"
        id="text_mkqw9854"
        placeholder="00.000.000/0001-00"
        maxlength="18"
        required
        pattern="\d{2}\.\d{3}\.\d{3}/\d{4}-\d{2}"
      >
    </label>

    <label id="labelCurador">
      Selecione o Curador:
      <select id="curador_mkqw6k20" required>
        <option value="">-- selecione --</option>
        <option>Curador 1</option>
        <option>Curador 2</option>
        <option>Curador 3</option>
        <option>Curador 4</option>
      </select>
    </label>

    <label id="labelRealizador">
      Selecione o Realizador:
      <select id="realizador_mkqw6k20" required>
        <option value="">-- selecione --</option>
        <option>Ampla</option>
        <option>Porto Digital</option>
        <option>Sebrae</option>
      </select>
    </label>

    <label id="labelPatrocinador">
      Selecione o Patrocinador:
      <select id="pat_mkqw6k20" required>
        <option value="">-- selecione --</option>
        <option>Prefeitura do Recife</option>
        <option>P2</option>
        <option>P3</option>
      </select>
    </label>

    <label id="labelSecretaria">
      Selecione a Secretaria:
      <select id="short_mkqxee4h" required>
        <option value="">-- selecione --</option>
        <option>S1</option>
        <option>S2</option>
        <option>S3</option>
      </select>
    </label>

    <label id="labelProponente">
      Nome do proponente:
      <input type="text" id="text_mkqxrmax" required>
    </label>

    <label id="labelEmail">
      E-mail:
      <input type="email" id="email_mkqw7x9b" placeholder="usuario@exemplo.com" required>
    </label>

    <label id="labelTelefone">
      Telefone:
      <input
        type="tel"
        id="tel_mkqxwjzj"
        placeholder="(11) 91234-5678"
        maxlength="15"
        pattern="\(\d{2}\) \d{4,5}-\d{4}"
        required
      >
    </label>

  
    <label>
      Nome da Atividade:
      <input type="text" id="text_mkqrhjas" required>
    </label>

    <label>
      Formato de Atividade:
      <select id="short_textossh5v4j" required>
        <option value="">-- selecione --</option>
        <option>Apresentação artística</option>
        <option>Apresentação de trabalhos</option>
        <option>Atendimentos</option>
        <option>Campeonato</option>
        <option>Contação de História</option>
        <option>Cortejo</option>
        <option>Demonstração</option>
        <option>Desfile de moda</option>
        <option>Exibição audiovisual</option>
        <option>Experiência</option>
        <option>Exposição artística</option>
        <option>Feira</option>
        <option>Hackathon</option>
        <option>Intervenção urbana</option>
        <option>Mentoria</option>
        <option>Mesa redonda</option>
        <option>Minicurso</option>
        <option>Oficina</option>
        <option>Palestra</option>
        <option>Pitchs</option>
        <option>Revisão de portfólio</option>
        <option>Roda de conversa</option>
        <option>Rodada de negócios</option>
        <option>Show</option>
        <option>Talk Show</option>
        <option>Visitas/ percursos guiados</option>
        <option>Workshop</option>
      </select>
    </label>

    <label id="daysLabel" class="hidden">
      Dias (1 a 4):
      <select id="short_textb7obn15q">
        <option value="">-- selecione --</option>
        <option value="1 dia">1 dia</option>
        <option value="2 dias">2 dias</option>
        <option value="3 dias">3 dias</option>
        <option value="4 dias">4 dias</option>
      </select>
    </label>

   <label id="durationLabel" class="hidden">
      Duração:
      <select id="text_mkqrvnnp">
        <option value="">-- selecione --</option>
      </select>
    </label>

    <label>
      Descrição:
      <textarea id="long_text_mkqr5e1x" rows="3" maxlength="700"></textarea>
      <div class="char-counter" id="descCounter">0/700</div>
    </label>

    <label>
      Tema Principal:
      <div id="temaPrincipalTree"></div>
      <input type="hidden" id="temaPrincipalValue" name="temaPrincipalValue">
    </label>

    <label>
      Tema Secundário:
      <div id="temaSecundarioTree"></div>
      <input type="hidden" id="temaSecundarioValue" name="temaSecundarioValue">
    </label>

    <label>
      Público:
      <select id="text_mkqr6nqa">
        <option value="">-- selecione --</option>
        <option>especialista no tema</option>
        <option>geral</option>
        <option>negócios</option>
        <option>infantil</option>
        <option>adolescentes</option>
        <option>apenas mulheres</option>
      </select>
    </label>

    <label id="maxGuestsLabel" class="hidden">
      max público:
      <select id="text_mkqrjadb">
        <option value="">-- selecione --</option>
        <option value="10">10</option>
        <option value="15">15</option>
        <option value="20">20</option>
        <option value="25">25</option>
        <option value="30">30</option>
        <option value="35">35</option>
        <option value="40">40</option>
        <option value="45">45</option>
        <option value="50">50</option>
        <option value="Sem restrição">Sem restrição</option>
      </select>
    </label>

    <label>
      Restrição de faixa etária:
      <select id="text_mkqrrpq3" required>
        <option value="">-- selecione --</option>
        <option value="Não">Não</option>
        <option value="Sim">Sim</option>
      </select>
    </label>
    <label id="ageRangeLabel" class="hidden">
      Informe a faixa etária:
      <input type="text" id="text_mkqrrpq3_range" placeholder="ex: 18-25">
    </label>

    <label>
      Informações extras:
      <textarea id="text_mkqrqmfw" rows="2" maxlength="700"></textarea>
      <div class="char-counter" id="extrasCounter">0/700</div>
    </label>

    <label>Convidados:</label>
    <div class="guest-slots" id="guestSlots"></div>

    <button type="submit">Criar Atividade</button>
  </form>

  <!-- modal de criação de convidado -->
  <div id="newGuestModal" class="modal hidden">
    <div class="content">
      <h3>Novo Convidado</h3>
      <input id="guestNameInput" placeholder="Nome" />
      <input id="guestCargoInput" placeholder="Cargo" />
      <input id="guestEmpresaInput" placeholder="Empresa" />
      <button id="saveGuestBtn" type="button">Salvar convidado</button>
      <button id="closeGuestModalBtn" type="button">Fechar</button>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const API_URL        = 'https://plain-butterfly-7001.programacao-e50.workers.dev';
  const BOARD_ID       = 9099133664;
  const GUEST_BOARD_ID = 9102764459;

  let selectedGuests = [];
  let guestsToCreate = [];

  // — GraphQL genérico —
  async function mondayMutation(query) {
    const res  = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query })
    });
    const json = await res.json();
    if (!res.ok || json.errors) {
      console.error('GraphQL Query:', query);
      console.error('GraphQL Response:', json);
      throw json.errors || json;
    }
    return json.data;
  }

  // — Slots de convidados —
  function renderSlots() {
    const c = document.getElementById('guestSlots');
    c.innerHTML = '';
    selectedGuests.forEach((g,i) => {
      const slot = document.createElement('div');
      slot.className = 'guest-slot';
      slot.textContent = g.name;
      const btn = document.createElement('button');
      btn.type = 'button'; btn.className = 'remove'; btn.innerHTML = '&times;';
      btn.onclick = () => { selectedGuests.splice(i,1); renderSlots(); };
      slot.appendChild(btn);
      c.appendChild(slot);
    });
    if (selectedGuests.length < 6) {
      const add = document.createElement('button');
      add.type = 'button'; add.id = 'addGuestBtn'; add.textContent = '+';
      add.onclick = () => {
        document.getElementById('newGuestModal').classList.remove('hidden');
        ['guestNameInput','guestCargoInput','guestEmpresaInput']
          .forEach(id => document.getElementById(id).value = '');
      };
      c.appendChild(add);
    }
  }

  // — Modal de convidados —
  document.getElementById('closeGuestModalBtn').onclick = () => {
    document.getElementById('newGuestModal').classList.add('hidden');
  };
  document.getElementById('saveGuestBtn').onclick = () => {
    const name    = document.getElementById('guestNameInput').value.trim();
    const cargo   = document.getElementById('guestCargoInput').value.trim();
    const empresa = document.getElementById('guestEmpresaInput').value.trim();
    if (!name) return alert('Informe ao menos o nome do convidado.');
    const guest = { id: null, name, cargo, empresa };
    selectedGuests.push(guest);
    guestsToCreate.push(guest);
    document.getElementById('newGuestModal').classList.add('hidden');
    renderSlots();
  };

  // — Tema → Subtema —
  const subtemasPorTema = {
    "Artes e Cultura": ["Arquitetura","Artes Visuais","Audiovisual","Circo","Cultura Maker","Cultura Popular","Dança","Fotografia","Gastronomia","HQ","Intervenções Urbanas","Literatura","Moda","Música","Patrimônio Imaterial","Teatro"],
    "Comunicação": ["Comunicação","Creator","Criação de Conteúdo","Design Gráfico/Industrial","Podcast"],
    "Dados e Segurança Digital": ["Análise de Dados","Blockchain","Cibersegurança","Governança de Dados","Investimentos/Criptomoedas","LGPD","NFT","Privacidade","Web3"],
    "Desenvolvimento de Software e Cloud": ["Desenvolvimento de Software e Cloud","Low Code/No Code","Programação de Software"],
    "Diversidade e Inclusão": ["50+","Acessibilidade/PCD","Equidade Racial","LGBTQIAPN+","Mulheres","Neurodivergência","Periferias"],
    "Empreendedorismo e Inovação": ["Ecossistemas de Inovação","Empresa Júnior","Gestão de Comunidades","Inovação Aberta","Internacionalização","Startup","Transformação Digital"],
    "Games e Design": ["Desenvolvimento de Jogos","e-Sports","Experiência do Usuário (UX/CX)","Gameficação","Interface do Usuário (UI)"],
    "Gente e Gestão": ["Carreira Profissional","Cultura Organizacional","Desenvolvimento de Times","Formação","RH","Softskills"],
    "Governança": ["ESG","Governança de Dados","Impacto Social","Legislação","Responsabilidade Social"],
    "Inteligência Artificial, Tecnologias Imersivas e Metaverso": ["Realidade Virtual","Deep Learning","Engenharia de Prompt","Inteligência Artificial","LLM","Machine Learning","Metaverso","Processamento de Linguagem Natural","Realidade Aumentada/Realidade Mista","Visão Computacional"],
    "Investimentos": ["Captação de Recursos","Investimento em Inovação","Criptomoedas"],
    "Política e Cidadania": ["Cidadania Digital","Direito","Educação","Empregabilidade","Geopolítica","Infância","Mobilidade Urbana","Saúde","Turismo","Urbanismo"],
    "Processos e Técnicas de Mercado": ["Agilidade","Atacado e Varejo","Branding","Canais de Venda","Comportamento do Consumidor","E-commerce","Experiência do Cliente","Marketing","Vendas B2B/B2C"],
    "Setores Tech": ["Agritech","Cleantech","Construtech","Ecotech","Edutech","Fintech","Foodtech","Govtech","Healthtech","Lawtech","Retailtech","Sportech"],
    "Simulação e Modelagem": ["Corte a Laser","Impressão 3D","Modelagem 3D"],
    "Sustentabilidade": ["Desenvolvimento Sustentável","Economia Circular","Eficiência Energética","Energia Renovável","Gestão de Resíduos","Logística Reversa","Meio Ambiente","Mudanças Climáticas","ODS"],
    "Tecnologias de Conectividade, Robótica e Computação Avançada": ["5G","6G","Computação Quântica","IoT","Robótica","Sistemas Embarcados"]
  };
  function buildTree(containerId, hiddenInputId) {
    const cont = document.getElementById(containerId),
          hid  = document.getElementById(hiddenInputId);
    cont.innerHTML = '';
    Object.entries(subtemasPorTema).forEach(([tema,subs]) => {
      const det = document.createElement('details'),
            sum = document.createElement('summary');
      sum.textContent = tema;
      det.appendChild(sum);
      subs.forEach(sub => {
        const div = document.createElement('div');
        div.className = 'subtema-item';
        div.textContent = sub;
        div.onclick = () => {
          hid.value = `${tema} → ${sub}`;
          cont.querySelectorAll('.subtema-item').forEach(el=>el.style.fontWeight='');
          div.style.fontWeight = 'bold';
        };
        det.appendChild(div);
      });
      cont.appendChild(det);
    });
  }
  buildTree('temaPrincipalTree','temaPrincipalValue');
  buildTree('temaSecundarioTree','temaSecundarioValue');

  // — Contadores de caracteres —
  document.getElementById('long_text_mkqr5e1x')
    .addEventListener('input', e => document.getElementById('descCounter').textContent = `${e.target.value.length}/700`);
  document.getElementById('text_mkqrqmfw')
    .addEventListener('input', e => document.getElementById('extrasCounter').textContent = `${e.target.value.length}/700`);

  // — Formato & Faixa etária dinâmicos —
  const fmt    = document.getElementById('short_textossh5v4j'),
        daysL  = document.getElementById('daysLabel'),
        maxL   = document.getElementById('maxGuestsLabel'),
        rs     = document.getElementById('text_mkqrrpq3'),
        ageL   = document.getElementById('ageRangeLabel'),
        showDays = new Set(['Atendimentos','Mentoria','Pitchs','Rodada de negócios','Oficina','Minicurso','Hackathon','Intervenção urbana','Demonstração','Experiência','Visitas/ percursos guiados','Campeonato','Exposição artística','Feira']),
        showMax  = new Set(['Mentoria','Pitchs','Revisão de portfólio','Rodada de negócios']);
  fmt.addEventListener('change', () => {
    daysL.classList.toggle('hidden', !showDays.has(fmt.value));
    maxL.classList.toggle('hidden', !showMax.has(fmt.value));
  });
  rs.addEventListener('change', () => {
    ageL.classList.toggle('hidden', rs.value !== 'Sim');
  });
  fmt.dispatchEvent(new Event('change'));
  rs.dispatchEvent(new Event('change'));

  // — Parceria / Secretaria —
  const partnership   = document.getElementById('short_mkqwxtt2'),
        sponsorSelect = document.getElementById('pat_mkqw6k20'),
        labels        = {
          empresa:      document.getElementById('labelEmpresa'),
          cnpj:         document.getElementById('labelCNPJ'),
          curador:      document.getElementById('labelCurador'),
          realizador:   document.getElementById('labelRealizador'),
          patrocinador: document.getElementById('labelPatrocinador'),
          secretaria:   document.getElementById('labelSecretaria'),
          proponente:   document.getElementById('labelProponente'),
          email:        document.getElementById('labelEmail'),
          telefone:     document.getElementById('labelTelefone')
        };
  function togglePartnerFields() {
    Object.values(labels).forEach(l => {
      l.classList.add('hidden');
      const ctl = l.querySelector('input,select');
      if (ctl) ctl.disabled = true;
    });
    const p = partnership.value;
    if (p === 'Parceiro de conteúdo') {
      ['empresa','cnpj','proponente','email','telefone'].forEach(k => {
        labels[k].classList.remove('hidden');
        labels[k].querySelector('input').disabled = false;
      });
    } else if (p === 'Curador') {
      labels.curador.classList.remove('hidden');
      labels.curador.querySelector('select').disabled = false;
    } else if (p === 'Realizador') {
      ['realizador','proponente','email','telefone'].forEach(k => {
        labels[k].classList.remove('hidden');
        labels[k].querySelector('input,select').disabled = false;
      });
    } else if (p === 'Patrocinador') {
      ['patrocinador','proponente','email','telefone'].forEach(k => {
        labels[k].classList.remove('hidden');
        labels[k].querySelector('input,select').disabled = false;
      });
      if (sponsorSelect.value === 'Prefeitura do Recife') {
        labels.secretaria.classList.remove('hidden');
        labels.secretaria.querySelector('select').disabled = false;
      }
    }
  }
  partnership.addEventListener('change', togglePartnerFields);
  sponsorSelect.addEventListener('change', togglePartnerFields);
  togglePartnerFields();


  function maskCNPJ(value) {
  value = value.replace(/\D/g, "");
  value = value.replace(/^(\d{2})(\d)/, "$1.$2");
  value = value.replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3");
  value = value.replace(/\.(\d{3})(\d)/, ".$1/$2");
  value = value.replace(/(\d{4})(\d)/, "$1-$2");
  return value;
}
function maskPhone(value) {
  value = value.replace(/\D/g, "");
  // DDD
  value = value.replace(/^(\d{2})(\d)/, "($1) $2");
  // Se tiver 5 dígitos no bloco, insere hífen após o quinto
  value = value.replace(/(\d{5})(\d)/, "$1-$2");
  // Limita tamanho máximo
  return value.slice(0, 15);
}

const cnpjInput   = document.getElementById('text_mkqw9854');
const phoneInput  = document.getElementById('tel_mkqxwjzj');

cnpjInput.addEventListener('input', e => {
  e.target.value = maskCNPJ(e.target.value);
});
phoneInput.addEventListener('input', e => {
  e.target.value = maskPhone(e.target.value);
});


  const durationMapping = {
  "00:30": [
    "Apresentação artística",
    "Apresentação de trabalhos",
    "Contação de História",
    "Demonstração",
    "Intervenção urbana",
    "Rodada de negócios"
  ],
  "00:45": [
    "Apresentação artística",
    "Apresentação de trabalhos",
    "Contação de História",
    "Palestra",
    "Rodada de negócios",
    "Visitas/ percursos guiados"
  ],
  "01:00": [
    "Apresentação artística","Apresentação de trabalhos","Atendimentos","Campeonato",
    "Contação de História","Cortejo","Demonstração","Desfile de moda",
    "Exibição audiovisual","Experiência","Exposição artística","Intervenção urbana",
    "Mentoria","Mesa redonda","Minicurso","Oficina","Palestra","Pitchs",
    "Revisão de portfólio","Roda de conversa","Rodada de negócios",
    "Show","Talk Show","Visitas/ percursos guiados","Workshop"
  ],
  "01:15": ["Mesa redonda","Oficina","Roda de conversa"],
  "01:30": [
    "Apresentação artística","Apresentação de trabalhos","Contação de História",
    "Cortejo","Demonstração","Desfile de moda","Exibição audiovisual",
    "Experiência","Intervenção urbana","Mentoria","Mesa redonda","Minicurso",
    "Oficina","Pitchs","Revisão de portfólio","Roda de conversa",
    "Rodada de negócios","Show","Talk Show","Visitas/ percursos guiados","Workshop"
  ],
  "01:45": ["Mesa redonda","Oficina","Roda de conversa"],
  "02:00": [
    "Apresentação artística","Apresentação de trabalhos","Atendimentos","Campeonato",
    "Cortejo","Demonstração","Desfile de moda","Exibição audiovisual",
    "Experiência","Exposição artística","Intervenção urbana","Mentoria",
    "Minicurso","Oficina","Pitchs","Revisão de portfólio","Rodada de negócios",
    "Show","Talk Show","Visitas/ percursos guiados","Workshop"
  ],
  "02:30": [
    "Apresentação artística","Exibição audiovisual","Oficina","Show","Workshop"
  ],
  "03:00": [
    "Apresentação artística","Atendimentos","Campeonato","Exibição audiovisual",
    "Experiência","Exposição artística","Hackathon","Oficina","Show",
    "Visitas/ percursos guiados","Workshop"
  ],
  "03:30": ["Exibição audiovisual"],
  "04:00": [
    "Atendimentos","Campeonato","Exibição audiovisual","Experiência",
    "Exposição artística","feira","Hackathon","Oficina","Show"
  ],
  "05:00": ["Hackathon","Show"],
  "09:00": ["Hackathon","Intervenção urbana","Mentoria","Oficina","Show"]
};

const durationSelect = document.getElementById('text_mkqrvnnp');
const durationLabel  = document.getElementById('durationLabel');

fmt.addEventListener('change', () => {
  // (já existente) showDays/showMax/ageRange...
  
  // 1) limpa opções anteriores
  durationSelect.innerHTML = '<option value="">-- selecione --</option>';
  
  // 2) formata valor para comparação
  const currFmt = fmt.value.trim().toLowerCase();
  
  // 3) para cada duração, se o formato atual estiver no mapeamento (comparação sem diferenciar maiúsculas/minúsculas), adiciona option
Object.entries(durationMapping).forEach(([time, formats]) => {
  // transforma todos os formatos em lowercase e compara
  const lowerFormats = formats.map(f => f.trim().toLowerCase());
  if (lowerFormats.includes(currFmt)) {
    const opt = document.createElement('option');
    opt.value = time;
    opt.textContent = time === '09:00' ? 'Dia todo' : time;
    durationSelect.appendChild(opt);
  }
});
  
  // 4) esconde todo o bloco se não houver opções (além do placeholder)
  durationLabel.classList.toggle('hidden', durationSelect.options.length <= 1);
});

// dispara uma vez para inicializar o estado corretamente
fmt.dispatchEvent(new Event('change'));
  // — Submissão —
  document.getElementById('activityForm').addEventListener('submit', async e => {
    e.preventDefault();

    // 1) Cria convidados
    if (guestsToCreate.length) {
      await Promise.all(guestsToCreate.map(async g => {
        const cols = { text_mkqreer2: g.name };
        if (g.cargo)   cols.text_mkqry55n = g.cargo;
        if (g.empresa) cols.text_mkqrghw1 = g.empresa;
        const esc = JSON.stringify(cols).replace(/"/g,'\\"');
        const q = `
          mutation {
            create_item(
              board_id: ${GUEST_BOARD_ID},
              item_name: "${g.name.replace(/"/g,'\\"')}",
              column_values: "${esc}"
            ) { id }
          }
        `;
        const res = await mondayMutation(q);
        g.id = res.create_item.id;
      }));
      guestsToCreate = [];
    }

    // 2) Monta atividade
    const title      = document.getElementById('text_mkqrhjas').value.replace(/"/g,'\\"');
    const fmtValue   = fmt.value;
    const days       = document.getElementById('short_textb7obn15q').value;
    const maxG       = document.getElementById('text_mkqrjadb').value;
    const duration   = document.getElementById('text_mkqrvnnp').value.replace(/"/g,'\\"');
    const desc       = document.getElementById('long_text_mkqr5e1x').value.replace(/"/g,'\\"');
    const extras     = document.getElementById('text_mkqrqmfw').value.replace(/"/g,'\\"');
    const restr      = document.getElementById('text_mkqrrpq3').value;
    const ageRange   = document.getElementById('text_mkqrrpq3_range').value.replace(/"/g,'\\"');
    const pub        = document.getElementById('text_mkqr6nqa').value;
    const [temaP, subP=''] = document.getElementById('temaPrincipalValue').value.split(' → ');
    const [temaS, subS=''] = document.getElementById('temaSecundarioValue').value.split(' → ');
    const partnerType      = partnership.value;
    let   partnerValue;
    switch (partnerType) {
      case 'Curador':      partnerValue = document.getElementById('curador_mkqw6k20').value; break;
      case 'Realizador':   partnerValue = document.getElementById('realizador_mkqw6k20').value; break;
      case 'Patrocinador': partnerValue = document.getElementById('pat_mkqw6k20').value; break;
      default:             partnerValue = document.getElementById('text_mkqw6k20').value; break;
    }
    const cnpj       = document.getElementById('text_mkqw9854').value;
    const secretaria = document.getElementById('short_mkqxee4h').value;
    const proponente = document.getElementById('text_mkqxrmax').value;
    const email      = document.getElementById('email_mkqw7x9b').value;
    const telefone   = document.getElementById('tel_mkqxwjzj').value;
    const guestIds   = selectedGuests
      .filter(g => g.id)
      .map(g => ({ linkedPulseId: parseInt(g.id,10) }));

    const vals = {
      text_mkqrhjas:      title,
      short_textossh5v4j: fmtValue,
      ...(days && { short_textb7obn15q: days }),
      ...(maxG && { text_mkqrjadb: maxG }),
      text_mkqrvnnp:      duration,
      long_text_mkqr5e1x: desc,
      text_mkqrqmfw:      extras,
      text_mkqrrpq3:      restr==='Sim'? ageRange : restr,
      text_mkqrwawz:      temaP,
      text_mkqrm18v:      subP,
      text_mkqrth67:      temaS,
      text_mkqrfjz3:      subS,
      text_mkqr6nqa:      pub,
      color_mkqr22e3:     { label:'Caixa de Entrada' },
      text_mkqwxtt2:      partnerType,
      text_mkqw6k20:      partnerValue,
      text_mkqw9854:      cnpj,
      text_mkqxee4h:      secretaria,
      text_mkqxrmax:      proponente,
      text_mkqw7x9b:      email,
      text_mkqxwjzj:      telefone,
      ...(guestIds.length && {
        board_relation_mkqr6b1t: { linkedPulseIds: guestIds }
      })
    };

    const colJson = JSON.stringify(vals)
      .replace(/\\/g,'\\\\')
      .replace(/"/g,'\\"')
      .replace(/\n/g,'\\n');

    const mutation = `
      mutation {
        create_item(
          board_id: ${BOARD_ID},
          item_name: "${title}",
          column_values: "${colJson}"
        ) { id }
      }
    `;
    try {
      const resp = await mondayMutation(mutation);
      alert('Atividade criada! ID: ' + resp.create_item.id);
      document.getElementById('activityForm').reset();
      selectedGuests = [];
      renderSlots();
      buildTree('temaPrincipalTree','temaPrincipalValue');
      buildTree('temaSecundarioTree','temaSecundarioValue');
      fmt.dispatchEvent(new Event('change'));
      rs.dispatchEvent(new Event('change'));
    } catch (err) {
      console.error(err);
      alert('Erro ao criar atividade. Veja console.');
    }
  });

  renderSlots();
});
</script>


</body>
</html>
