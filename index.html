<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro Completo de Atividade</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; }
    form { display: grid; gap: 1rem; }
    label { display: flex; flex-direction: column; }
    input, textarea, select, button { padding: .4rem; font-size: 1rem; }
    button { width: fit-content; cursor: pointer; }
    .char-counter { font-size: .9rem; color: #666; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>Nova Atividade</h1>
  <form id="activityForm">

    <label>
      Nome da Atividade:
      <input type="text" id="text_mkqrhjas" required>
    </label>

    <label>
      Formato de Atividade:
      <select id="short_textossh5v4j" required>
        <option value="">-- selecione --</option>
        <option>Apresentação artística</option>
        <option>Apresentação de trabalhos</option>
        <option>Atendimentos</option>
        <option>Campeonato</option>
        <option>Contação de História</option>
        <option>Cortejo</option>
        <option>Demonstração</option>
        <option>Desfile de moda</option>
        <option>Exibição audiovisual</option>
        <option>Experiência</option>
        <option>Exposição artística</option>
        <option>Feira</option>
        <option>Hackathon</option>
        <option>Intervenção urbana</option>
        <option>Mentoria</option>
        <option>Mesa redonda</option>
        <option>Minicurso</option>
        <option>Oficina</option>
        <option>Palestra</option>
        <option>Pitchs</option>
        <option>Revisão de portfólio</option>
        <option>Roda de conversa</option>
        <option>Rodada de negócios</option>
        <option>Show</option>
        <option>Talk Show</option>
        <option>Visitas/ percursos guiados</option>
        <option>Workshop</option>
      </select>
    </label>

    <label id="daysLabel" class="hidden">
      Dias (1 a 4):
      <select id="short_textb7obn15q">
        <option value="">-- selecione --</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
      </select>
    </label>

    <label>
      Duração (text_mkqrvnnp):
      <input type="text" id="text_mkqrvnnp">
    </label>

    <label>
      Descrição (max 700 caracteres):
      <textarea id="long_text_mkqr5e1x" rows="3" maxlength="700"></textarea>
      <div class="char-counter" id="descCounter">0/700</div>
    </label>

    <label>
      Tema Principal:
      <select id="text_mkqrwawz">
        <option value="">-- selecione --</option>
        <option>Artes e Cultura</option>
        <option>Comunicação</option>
        <option>Dados e Segurança Digital</option>
        <option>Desenvolvimento de Software e Cloud</option>
        <option>Diversidade e Inclusão</option>
        <option>Empreendedorismo e Inovação</option>
        <option>Games e Design</option>
        <option>Gente e Gestão</option>
        <option>Governança</option>
        <option>Inteligência Artificial, Tecnologias Imersivas e Metaverso</option>
        <option>Investimentos</option>
        <option>Política e Cidadania</option>
        <option>Processos e Técnicas de Mercado</option>
        <option>Setores Tech</option>
        <option>Simulação e Modelagem</option>
        <option>Sustentabilidade</option>
        <option>Tecnologias de Conectividade, Robótica e Computação Avançada</option>
      </select>
    </label>

    <label>
      Tema Secundário:
      <select id="text_mkqrth67">
        <option value="">-- selecione --</option>
        <option>Artes e Cultura</option>
        <option>Comunicação</option>
        <option>Dados e Segurança Digital</option>
        <option>Desenvolvimento de Software e Cloud</option>
        <option>Diversidade e Inclusão</option>
        <option>Empreendedorismo e Inovação</option>
        <option>Games e Design</option>
        <option>Gente e Gestão</option>
        <option>Governança</option>
        <option>Inteligência Artificial, Tecnologias Imersivas e Metaverso</option>
        <option>Investimentos</option>
        <option>Política e Cidadania</option>
        <option>Processos e Técnicas de Mercado</option>
        <option>Setores Tech</option>
        <option>Simulação e Modelagem</option>
        <option>Sustentabilidade</option>
        <option>Tecnologias de Conectividade, Robótica e Computação Avançada</option>
      </select>
    </label>

    <label>
      Subtema Principal:
      <select id="text_mkqrm18v">
        <option value="">-- selecione --</option>
        <option>Artes e Cultura</option>
        <option>Comunicação</option>
        <option>Dados e Segurança Digital</option>
        <option>Desenvolvimento de Software e Cloud</option>
        <option>Diversidade e Inclusão</option>
        <option>Empreendedorismo e Inovação</option>
        <option>Games e Design</option>
        <option>Gente e Gestão</option>
        <option>Governança</option>
        <option>Inteligência Artificial, Tecnologias Imersivas e Metaverso</option>
        <option>Investimentos</option>
        <option>Política e Cidadania</option>
        <option>Processos e Técnicas de Mercado</option>
        <option>Setores Tech</option>
        <option>Simulação e Modelagem</option>
        <option>Sustentabilidade</option>
        <option>Tecnologias de Conectividade, Robótica e Computação Avançada</option>
      </select>
    </label>

    <label>
      Subtema Secundário:
      <select id="text_mkqrfjz3">
        <option value="">-- selecione --</option>
        <option>Artes e Cultura</option>
        <option>Comunicação</option>
        <option>Dados e Segurança Digital</option>
        <option>Desenvolvimento de Software e Cloud</option>
        <option>Diversidade e Inclusão</option>
        <option>Empreendedorismo e Inovação</option>
        <option>Games e Design</option>
        <option>Gente e Gestão</option>
        <option>Governança</option>
        <option>Inteligência Artificial, Tecnologias Imersivas e Metaverso</option>
        <option>Investimentos</option>
        <option>Política e Cidadania</option>
        <option>Processos e Técnicas de Mercado</option>
        <option>Setores Tech</option>
        <option>Simulação e Modelagem</option>
        <option>Sustentabilidade</option>
        <option>Tecnologias de Conectividade, Robótica e Computação Avançada</option>
      </select>
    </label>

    <label>
      público:
      <select id="text_mkqr6nqa">
        <option value="">-- selecione --</option>
        <option>especialista no tema</option>
        <option>geral</option>
        <option>negócios</option>
        <option>infantil</option>
        <option>adolescentes</option>
        <option>apenas mulheres</option>
      </select>
    </label>

    <label id="maxGuestsLabel" class="hidden">
      max público:
      <select id="text_mkqrjadb">
        <option value="">-- selecione --</option>
        <option value="10">10</option>
        <option value="15">15</option>
        <option value="20">20</option>
        <option value="25">25</option>
        <option value="30">30</option>
        <option value="35">35</option>
        <option value="40">40</option>
        <option value="45">45</option>
        <option value="50">50</option>
        <option value="Sem restrição">Sem restrição</option>
      </select>
    </label>

     <!-- Restrição de faixa etária -->
     <label>
        Restrição de faixa etária (text_mkqrrpq3):
        <select id="text_mkqrrpq3" required>
          <option value="">-- selecione --</option>
          <option value="Não">Não</option>
          <option value="Sim">Sim</option>
        </select>
      </label>
      <label id="ageRangeLabel" class="hidden">
        Informe a faixa etária (text_mkqrrpq3_range):
        <input type="text" id="text_mkqrrpq3_range" placeholder="ex: 18-25">
      </label>
  

    <label>
      Informações extras (max 700 caracteres):
      <textarea id="text_mkqrqmfw" rows="2" maxlength="700"></textarea>
      <div class="char-counter" id="extrasCounter">0/700</div>
    </label>

   
     <label>Convidados:</label>
    <div class="guest-slots" id="guestSlots">
      <!-- aqui serão adicionados até 6 .guest-slot -->
    </div>
    <button type="button" id="addGuestBtn">+</button>

    <button type="submit">Criar Atividade</button>
  </form>
  <!-- Modal de busca -->
  <div class="modal hidden" id="guestModal">
    <div class="content">
      <h3>Buscar Convidado</h3>
      <input type="text" id="guestSearchInput" placeholder="Nome, cargo ou empresa" style="width:100%; padding:.4rem"/>
      <ul id="guestSearchResults"></ul>
      <button id="closeGuestModal">Fechar</button>
    </div>
  </div>  

 <script>
  // Configurações
  const API_URL = 'https://plain-butterfly-7001.programacao-e50.workers.dev';
  const BOARD_ID = 9099133664;
  const GUEST_BOARD_ID = 9102764459;

  // Guarda toda a lista de convidados e os selecionados
  let loadedGuests = [];
  let selectedGuests = [];

  // Faz qualquer query GraphQL ao seu Worker→Monday
  async function mondayMutation(query) {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query })
    });
    const j = await res.json();
    if (!res.ok) throw j.errors || j;
    if (j.errors) throw j.errors;
    return j.data;
  }

  // Carrega os convidados do board de convidados, incluindo cargo e empresa
  async function loadGuests() {
    // Substitua "cargo_column_id" e "empresa_column_id" pelos IDs reais dessas colunas no seu board de convidados
    const q = `query {
      boards(ids:[${GUEST_BOARD_ID}]) {
        items_page(limit:100) {
          items {
            id
            name
            column_values(ids:["cargo_column_id","empresa_column_id"]) {
              id text
            }
          }
        }
      }
    }`;
    try {
      const data = await mondayMutation(q);
      loadedGuests = data.boards[0].items_page.items.map(item => ({
        id:      parseInt(item.id,10),
        name:    item.name,
        cargo:   item.column_values.find(c=>c.id==="cargo_column_id")?.text||"",
        empresa: item.column_values.find(c=>c.id==="empresa_column_id")?.text||""
      }));
    } catch (err) {
      console.error('Erro ao carregar convidados:', err);
      alert('Não foi possível carregar a lista de convidados. Veja o console.');
    }
  }

  // Renderiza os slots de convidados na tela
  function renderSlots() {
    const container = document.getElementById('guestSlots');
    container.innerHTML = '';
    selectedGuests.forEach((g, i) => {
      const div = document.createElement('div');
      div.className = 'guest-slot';
      div.textContent = g.name;
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'remove';
      btn.innerHTML = '&times;';
      btn.onclick = () => { selectedGuests.splice(i,1); renderSlots(); };
      div.appendChild(btn);
      container.appendChild(div);
    });
    if (selectedGuests.length < 6) {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.id = 'addGuestBtn';
      btn.textContent = '+';
      btn.onclick = openGuestModal;
      container.appendChild(btn);
    }
  }

  // Abre o modal de busca
  function openGuestModal() {
    document.getElementById('guestModal').classList.remove('hidden');
    document.getElementById('guestSearchInput').value = '';
    showSearchResults(loadedGuests.slice(0,10));
  }

  // Fecha o modal
  function closeGuestModal() {
    document.getElementById('guestModal').classList.add('hidden');
  }

  // Exibe na lista do modal os convidados filtrados
  function showSearchResults(list) {
    const ul = document.getElementById('guestSearchResults');
    ul.innerHTML = '';
    list.forEach(g => {
      const li = document.createElement('li');
      li.innerHTML = `<strong>${g.name}</strong><br/><small>${g.cargo} @ ${g.empresa}</small>`;
      li.onclick = () => {
        selectedGuests.push(g);
        closeGuestModal();
        renderSlots();
      };
      ul.appendChild(li);
    });
  }

  // Filtra enquanto digita
  document.getElementById('guestSearchInput').addEventListener('input', e => {
    const term = e.target.value.toLowerCase();
    const filtered = loadedGuests.filter(g =>
      g.name.toLowerCase().includes(term) ||
      g.cargo.toLowerCase().includes(term) ||
      g.empresa.toLowerCase().includes(term)
    );
    showSearchResults(filtered.slice(0,20));
  });
  document.getElementById('closeGuestModal').onclick = closeGuestModal;

  // Quando o form for submetido, inclui selectedGuests no payload e envia
  document.getElementById('activityForm').addEventListener('submit', async e => {
    e.preventDefault();
    // Coleta os demais campos do form em vals…
    const vals = {
      text_mkqrhjas: document.getElementById('text_mkqrhjas').value,
      short_textossh5v4j: document.getElementById('short_textossh5v4j').value,
      // … (outros campos text como antes) …
      color_mkqr22e3: { label: 'Parado' },
      // board_relation formatado corretamente:
      ...(selectedGuests.length && {
        board_relation_mkqr6b1t: {
          linkedPulseIds: selectedGuests.map(g => ({ linkedPulseId: g.id }))
        }
      })
    };

    // Escapa JSON para GraphQL
    const colJson = JSON.stringify(vals)
      .replace(/\\/g,'\\\\')
      .replace(/"/g,'\\"')
      .replace(/\n/g,'\\n');

    const title = vals.text_mkqrhjas.replace(/"/g,'\\"');
    const mutation = `
      mutation {
        create_item(
          board_id: ${BOARD_ID},
          item_name: "${title}",
          column_values: "${colJson}"
        ) { id }
      }
    `;
    try {
      const data = await mondayMutation(mutation);
      alert('Atividade criada! ID: ' + data.create_item.id);
      // reset do form e slots
      document.getElementById('activityForm').reset();
      selectedGuests = [];
      renderSlots();
    } catch (err) {
      console.error('Erro ao criar atividade:', err);
      alert('Não foi possível criar a atividade. Veja o console.');
    }
  });

  // Inicialização
  (async () => {
    await loadGuests();
    renderSlots();
  })();
</script>
</body>
</html>
