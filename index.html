<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro Completo de Atividade</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; }
    form { display: grid; gap: 1rem; }
    label { display: flex; flex-direction: column; }
    input, textarea, select, button { padding: .4rem; font-size: 1rem; }
    button { width: fit-content; cursor: pointer; }
    .char-counter { font-size: .9rem; color: #666; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>Nova Atividade</h1>
  <form id="activityForm">

    <label>
      Nome da Atividade:
      <input type="text" id="text_mkqrhjas" required>
    </label>

    <label>
      Formato de Atividade:
      <select id="short_textossh5v4j" required>
        <option value="">-- selecione --</option>
        <option>Apresentação artística</option>
        <option>Apresentação de trabalhos</option>
        <option>Atendimentos</option>
        <option>Campeonato</option>
        <option>Contação de História</option>
        <option>Cortejo</option>
        <option>Demonstração</option>
        <option>Desfile de moda</option>
        <option>Exibição audiovisual</option>
        <option>Experiência</option>
        <option>Exposição artística</option>
        <option>Feira</option>
        <option>Hackathon</option>
        <option>Intervenção urbana</option>
        <option>Mentoria</option>
        <option>Mesa redonda</option>
        <option>Minicurso</option>
        <option>Oficina</option>
        <option>Palestra</option>
        <option>Pitchs</option>
        <option>Revisão de portfólio</option>
        <option>Roda de conversa</option>
        <option>Rodada de negócios</option>
        <option>Show</option>
        <option>Talk Show</option>
        <option>Visitas/ percursos guiados</option>
        <option>Workshop</option>
      </select>
    </label>

    <label id="daysLabel" class="hidden">
      Dias (1 a 4):
      <select id="short_textb7obn15q">
        <option value="">-- selecione --</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
      </select>
    </label>

    <label>
      Duração (text_mkqrvnnp):
      <input type="text" id="text_mkqrvnnp">
    </label>

    <label>
      Descrição (max 700 caracteres):
      <textarea id="long_text_mkqr5e1x" rows="3" maxlength="700"></textarea>
      <div class="char-counter" id="descCounter">0/700</div>
    </label>

    <label>
      Tema Principal:
      <select id="text_mkqrwawz">
        <option value="">-- selecione --</option>
        <option>Artes e Cultura</option>
        <option>Comunicação</option>
        <option>Dados e Segurança Digital</option>
        <option>Desenvolvimento de Software e Cloud</option>
        <option>Diversidade e Inclusão</option>
        <option>Empreendedorismo e Inovação</option>
        <option>Games e Design</option>
        <option>Gente e Gestão</option>
        <option>Governança</option>
        <option>Inteligência Artificial, Tecnologias Imersivas e Metaverso</option>
        <option>Investimentos</option>
        <option>Política e Cidadania</option>
        <option>Processos e Técnicas de Mercado</option>
        <option>Setores Tech</option>
        <option>Simulação e Modelagem</option>
        <option>Sustentabilidade</option>
        <option>Tecnologias de Conectividade, Robótica e Computação Avançada</option>
      </select>
    </label>

    <label>
      Tema Secundário:
      <select id="text_mkqrth67">
        <option value="">-- selecione --</option>
        <option>Artes e Cultura</option>
        <option>Comunicação</option>
        <option>Dados e Segurança Digital</option>
        <option>Desenvolvimento de Software e Cloud</option>
        <option>Diversidade e Inclusão</option>
        <option>Empreendedorismo e Inovação</option>
        <option>Games e Design</option>
        <option>Gente e Gestão</option>
        <option>Governança</option>
        <option>Inteligência Artificial, Tecnologias Imersivas e Metaverso</option>
        <option>Investimentos</option>
        <option>Política e Cidadania</option>
        <option>Processos e Técnicas de Mercado</option>
        <option>Setores Tech</option>
        <option>Simulação e Modelagem</option>
        <option>Sustentabilidade</option>
        <option>Tecnologias de Conectividade, Robótica e Computação Avançada</option>
      </select>
    </label>

    <label>
      Subtema Principal:
      <select id="text_mkqrm18v">
        <option value="">-- selecione --</option>
        <option>Artes e Cultura</option>
        <option>Comunicação</option>
        <option>Dados e Segurança Digital</option>
        <option>Desenvolvimento de Software e Cloud</option>
        <option>Diversidade e Inclusão</option>
        <option>Empreendedorismo e Inovação</option>
        <option>Games e Design</option>
        <option>Gente e Gestão</option>
        <option>Governança</option>
        <option>Inteligência Artificial, Tecnologias Imersivas e Metaverso</option>
        <option>Investimentos</option>
        <option>Política e Cidadania</option>
        <option>Processos e Técnicas de Mercado</option>
        <option>Setores Tech</option>
        <option>Simulação e Modelagem</option>
        <option>Sustentabilidade</option>
        <option>Tecnologias de Conectividade, Robótica e Computação Avançada</option>
      </select>
    </label>

    <label>
      Subtema Secundário:
      <select id="text_mkqrfjz3">
        <option value="">-- selecione --</option>
        <option>Artes e Cultura</option>
        <option>Comunicação</option>
        <option>Dados e Segurança Digital</option>
        <option>Desenvolvimento de Software e Cloud</option>
        <option>Diversidade e Inclusão</option>
        <option>Empreendedorismo e Inovação</option>
        <option>Games e Design</option>
        <option>Gente e Gestão</option>
        <option>Governança</option>
        <option>Inteligência Artificial, Tecnologias Imersivas e Metaverso</option>
        <option>Investimentos</option>
        <option>Política e Cidadania</option>
        <option>Processos e Técnicas de Mercado</option>
        <option>Setores Tech</option>
        <option>Simulação e Modelagem</option>
        <option>Sustentabilidade</option>
        <option>Tecnologias de Conectividade, Robótica e Computação Avançada</option>
      </select>
    </label>

    <label>
      público:
      <select id="text_mkqr6nqa">
        <option value="">-- selecione --</option>
        <option>especialista no tema</option>
        <option>geral</option>
        <option>negócios</option>
        <option>infantil</option>
        <option>adolescentes</option>
        <option>apenas mulheres</option>
      </select>
    </label>

    <label id="maxGuestsLabel" class="hidden">
      max público:
      <select id="text_mkqrjadb">
        <option value="">-- selecione --</option>
        <option value="10">10</option>
        <option value="15">15</option>
        <option value="20">20</option>
        <option value="25">25</option>
        <option value="30">30</option>
        <option value="35">35</option>
        <option value="40">40</option>
        <option value="45">45</option>
        <option value="50">50</option>
        <option value="Sem restrição">Sem restrição</option>
      </select>
    </label>

     <!-- Restrição de faixa etária -->
     <label>
        Restrição de faixa etária (text_mkqrrpq3):
        <select id="text_mkqrrpq3" required>
          <option value="">-- selecione --</option>
          <option value="Não">Não</option>
          <option value="Sim">Sim</option>
        </select>
      </label>
      <label id="ageRangeLabel" class="hidden">
        Informe a faixa etária (text_mkqrrpq3_range):
        <input type="text" id="text_mkqrrpq3_range" placeholder="ex: 18-25">
      </label>
  

    <label>
      Informações extras (max 700 caracteres):
      <textarea id="text_mkqrqmfw" rows="2" maxlength="700"></textarea>
      <div class="char-counter" id="extrasCounter">0/700</div>
    </label>

   
     <label>Convidados:</label>
    <div class="guest-slots" id="guestSlots">
      <!-- aqui serão adicionados até 6 .guest-slot -->
    </div>

    <button type="submit">Criar Atividade</button>
  </form>
  <!-- Modal de busca -->
  <div class="modal hidden" id="guestModal">
    <div class="content">
      <h3>Buscar Convidado</h3>
      <input type="text" id="guestSearchInput" placeholder="Nome, cargo ou empresa" style="width:100%; padding:.4rem"/>
      <ul id="guestSearchResults"></ul>
      <button id="closeGuestModal">Fechar</button>
    </div>
  </div>  

<script>
  // ————— Configurações —————
  const API_URL = 'https://plain-butterfly-7001.programacao-e50.workers.dev';
  const BOARD_ID = 9099133664;
  const GUEST_BOARD_ID = 9102764459;

  let loadedGuests = [];
  let selectedGuests = [];

  // ————— Função GraphQL genérica —————
  async function mondayMutation(query) {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query })
    });
    const j = await res.json();
    if (!res.ok) throw j.errors || j;
    if (j.errors) throw j.errors;
    return j.data;
  }

  // ————— Carrega convidados —————
  async function loadGuests() {
    const q = `query {
      boards(ids:[${GUEST_BOARD_ID}]) {
        items_page(limit:100) {
          items {
            id
            column_values(ids:["text_mkqreer2","text_mkqry55n","text_mkqrghw1"]) { id text }
          }
        }
      }
    }`;
    try {
      const data = await mondayMutation(q);
      loadedGuests = data.boards[0].items_page.items.map(item => {
        const cols = item.column_values;
        return {
          id:      +item.id,
          name:    cols.find(c=>c.id==="text_mkqreer2")?.text||"",
          cargo:   cols.find(c=>c.id==="text_mkqry55n")?.text||"",
          empresa: cols.find(c=>c.id==="text_mkqrghw1")?.text||""
        };
      });
    } catch (err) {
      console.error('Erro ao carregar convidados:', err);
      alert('Falha ao carregar convidados. Veja o console.');
    }
  }

  // ————— Renderiza slots —————
  function renderSlots() {
    const c = document.getElementById('guestSlots');
    c.innerHTML = '';
    selectedGuests.forEach((g,i) => {
      const d = document.createElement('div');
      d.className = 'guest-slot';
      d.textContent = g.name;
      const btn = document.createElement('button');
      btn.type = 'button'; btn.className = 'remove';
      btn.innerHTML = '&times;';
      btn.onclick = () => { selectedGuests.splice(i,1); renderSlots(); };
      d.appendChild(btn);
      c.appendChild(d);
    });
    if (selectedGuests.length < 6) {
      const b = document.createElement('button');
      b.type = 'button'; b.id = 'addGuestBtn'; b.textContent = '+';
      b.onclick = openGuestModal;
      c.appendChild(b);
    }
  }

  // ————— Modal de busca —————
  function openGuestModal() {
    document.getElementById('guestModal').classList.remove('hidden');
    document.getElementById('guestSearchInput').value = '';
    showSearchResults(loadedGuests.slice(0,10));
  }
  function closeGuestModal() {
    document.getElementById('guestModal').classList.add('hidden');
  }
  function showSearchResults(list) {
    const ul = document.getElementById('guestSearchResults');
    ul.innerHTML = '';
    list.forEach(g => {
      const li = document.createElement('li');
      li.innerHTML = `<strong>${g.name}</strong><br/><small>${g.cargo} — ${g.empresa}</small>`;
      li.onclick = () => { selectedGuests.push(g); closeGuestModal(); renderSlots(); };
      ul.appendChild(li);
    });
  }
  document.getElementById('guestSearchInput')
    .addEventListener('input', e => {
      const t = e.target.value.toLowerCase();
      showSearchResults(
        loadedGuests.filter(g =>
          g.name.toLowerCase().includes(t) ||
          g.cargo.toLowerCase().includes(t) ||
          g.empresa.toLowerCase().includes(t)
        ).slice(0,20)
      );
    });
  document.getElementById('closeGuestModal').onclick = closeGuestModal;

  // ————— Contadores de caracteres —————
  document.getElementById('long_text_mkqr5e1x')
    .addEventListener('input', e => {
      document.getElementById('descCounter').textContent =
        `${e.target.value.length}/700`;
    });
  document.getElementById('text_mkqrqmfw')
    .addEventListener('input', e => {
      document.getElementById('extrasCounter').textContent =
        `${e.target.value.length}/700`;
    });

  // ————— Toggle campos dinâmicos —————
  const fmt = document.getElementById('short_textossh5v4j');
  const daysL = document.getElementById('daysLabel');
  const maxL  = document.getElementById('maxGuestsLabel');
  const rs    = document.getElementById('text_mkqrrpq3');
  const ageL  = document.getElementById('ageRangeLabel');
  const showD = new Set(['Atendimentos','Mentoria','Pitchs','Rodada de negócios','Oficina','Minicurso','Hackathon','Intervenção urbana','Demonstração','Experiência','Visitas/ percursos guiados','Campeonato','Exposição artística','Feira']);
  const showM = new Set(['Mentoria','Pitchs','Revisão de portfólio','Rodada de negócios']);
  function toggleF() {
    daysL.classList.toggle('hidden', !showD.has(fmt.value));
    maxL.classList.toggle('hidden', !showM.has(fmt.value));
  }
  function toggleA() {
    ageL.classList.toggle('hidden', rs.value !== 'Sim');
  }
  fmt.addEventListener('change', toggleF);
  rs.addEventListener('change', toggleA);
  toggleF(); toggleA();

  // ————— Submissão do form —————
  document.getElementById('activityForm')
    .addEventListener('submit', async e => {
      e.preventDefault();
      // coleta
      const tRaw = document.getElementById('text_mkqrhjas').value;
      const tEsc = tRaw.replace(/"/g,'\\"');
      const fmtV = fmt.value;
      const daysV= document.getElementById('short_textb7obn15q').value;
      const maxV = document.getElementById('text_mkqrjadb').value;
      const dur  = document.getElementById('text_mkqrvnnp').value;
      const des  = document.getElementById('long_text_mkqr5e1x').value;
      const ext  = document.getElementById('text_mkqrqmfw').value;
      const rsV  = rs.value;
      const agV  = document.getElementById('text_mkqrrpq3_range').value;
      const t1   = document.getElementById('text_mkqrwawz').value;
      const t2   = document.getElementById('text_mkqrth67').value;
      const s1   = document.getElementById('text_mkqrm18v').value;
      const s2   = document.getElementById('text_mkqrfjz3').value;
      const pub  = document.getElementById('text_mkqr6nqa').value;
      const guestIds = selectedGuests.map(g=>g.id);

      // monta vals
      const vals = {
        text_mkqrhjas:      tRaw,
        short_textossh5v4j: fmtV,
        ...(daysV && { short_textb7obn15q: daysV }),
        ...(maxV  && { text_mkqrjadb:      maxV }),
        text_mkqrvnnp:      dur,
        long_text_mkqr5e1x: des,
        text_mkqrqmfw:      ext,
        text_mkqrrpq3:      rsV==='Sim'?agV:rsV,
        text_mkqrwawz:      t1,
        text_mkqrth67:      t2,
        text_mkqrm18v:      s1,
        text_mkqrfjz3:      s2,
        text_mkqr6nqa:      pub,
        color_mkqr22e3:     { label:'Parado' },
        ...(guestIds.length && {
          board_relation_mkqr6b1t:{
            linkedPulseIds: guestIds.map(id=>({ linkedPulseId:id }))
          }})
      };

      // stringify + escape
      const colJson = JSON.stringify(vals)
        .replace(/\\/g,'\\\\')
        .replace(/"/g,'\\"')
        .replace(/\n/g,'\\n');
      const mutation = `
        mutation {
          create_item(
            board_id: ${BOARD_ID},
            item_name: "${tEsc}",
            column_values: "${colJson}"
          ) { id }
        }
      `;
      // envia
      try {
        const data = await mondayMutation(mutation);
        alert('Atividade criada! ID: '+data.create_item.id);
        document.getElementById('activityForm').reset();
        selectedGuests=[];
        renderSlots();
        toggleF(); toggleA();
      } catch(err) {
        if(Array.isArray(err)) {
          err.forEach((e,i)=>{
            console.error(`❌ GraphQL [${i}]:`,e.message,e.extensions?.error_data);
          });
          alert('Falha:\n'+err.map(e=>e.message).join('\n'));
        } else if(err.error){
          console.error('Worker:',err.error);
          alert('Worker:\n'+err.error);
        } else {
          console.error('Unexpected:',err);
          alert('Erro inesperado. Veja console.');
        }
      }
    });

  // ————— Inicializa —————
  (async()=>{
    await loadGuests();
    renderSlots();
  })();
</script>


</body>
</html>
