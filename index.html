<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro Completo de Atividade</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; }
    form { display: grid; gap: 1rem; }
    label { display: flex; flex-direction: column; }
    input, textarea, select, button { padding: .4rem; font-size: 1rem; }
    .char-counter { font-size: .9rem; color: #666; }
    .hidden { display: none; }

    .guest-slots { display: flex; flex-wrap: wrap; gap: .5rem; margin-top: .5rem; }
    .guest-slot { background: #8A2BE2; color: #fff; padding: .5rem 1rem; border-radius: 8px; display: flex; align-items: center; }
    .guest-slot .remove { background: transparent; border: none; color: #fff; margin-left: .5rem; cursor: pointer; }

    #addGuestBtn { background: #00FF7F; border: none; width: 2rem; height: 2rem; border-radius: 50%; font-size: 1.5rem; cursor: pointer; }

    .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; }
    .modal.hidden { display: none; }
    .modal .content { background: #fff; padding: 2rem; border-radius: 8px; width:90%; max-width:400px; }
    .modal .content input { width:100%; margin-bottom:1rem; }
  </style>
</head>
<body>
  <h1>Noaa Atividade</h1>
  <form id="activityForm">
    <label>
      Nome da Atividade:
      <input type="text" id="text_mkqrhjas" required>
    </label>

    <label>
      Formato de Atividade:
      <select id="short_textossh5v4j" required>
        <option value="">-- selecione --</option>
        <option>Apresentação artística</option>
        <option>Apresentação de trabalhos</option>
        <option>Atendimentos</option>
        <option>Campeonato</option>
        <option>Contação de História</option>
        <option>Cortejo</option>
        <option>Demonstração</option>
        <option>Desfile de moda</option>
        <option>Exibição audiovisual</option>
        <option>Experiência</option>
        <option>Exposição artística</option>
        <option>Feira</option>
        <option>Hackathon</option>
        <option>Intervenção urbana</option>
        <option>Mentoria</option>
        <option>Mesa redonda</option>
        <option>Minicurso</option>
        <option>Oficina</option>
        <option>Palestra</option>
        <option>Pitchs</option>
        <option>Revisão de portfólio</option>
        <option>Roda de conversa</option>
        <option>Rodada de negócios</option>
        <option>Show</option>
        <option>Talk Show</option>
        <option>Visitas/ percursos guiados</option>
        <option>Workshop</option>
      </select>
    </label>

    <label id="daysLabel" class="hidden">
      Dias (1 a 4):
      <select id="short_textb7obn15q">
        <option value="">-- selecione --</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
      </select>
    </label>

    <label>
      Duração:
      <input type="text" id="text_mkqrvnnp">
    </label>

    <label>
      Descrição:
      <textarea id="long_text_mkqr5e1x" rows="3" maxlength="700"></textarea>
      <div class="char-counter" id="descCounter">0/700</div>
    </label>

    <label>
      Tema Principal:
      <div id="temaPrincipalTree"></div>
      <input type="hidden" id="temaPrincipalValue" name="temaPrincipalValue">
    </label>

    <label>
      Tema Secundário:
      <div id="temaSecundarioTree"></div>
      <input type="hidden" id="temaSecundarioValue" name="temaSecundarioValue">
    </label>

    <label>
      Público:
      <select id="text_mkqr6nqa">
        <option value="">-- selecione --</option>
        <option>especialista no tema</option>
        <option>geral</option>
        <option>negócios</option>
        <option>infantil</option>
        <option>adolescentes</option>
        <option>apenas mulheres</option>
      </select>
    </label>

    <label id="maxGuestsLabel" class="hidden">
      max público:
      <select id="text_mkqrjadb">
        <option value="">-- selecione --</option>
        <option value="10">10</option>
        <option value="15">15</option>
        <option value="20">20</option>
        <option value="25">25</option>
        <option value="30">30</option>
        <option value="35">35</option>
        <option value="40">40</option>
        <option value="45">45</option>
        <option value="50">50</option>
        <option value="Sem restrição">Sem restrição</option>
      </select>
    </label>

    <label>
      Restrição de faixa etária:
      <select id="text_mkqrrpq3" required>
        <option value="">-- selecione --</option>
        <option value="Não">Não</option>
        <option value="Sim">Sim</option>
      </select>
    </label>
    <label id="ageRangeLabel" class="hidden">
      Informe a faixa etária:
      <input type="text" id="text_mkqrrpq3_range" placeholder="ex: 18-25">
    </label>

    <label>
      Informações extras:
      <textarea id="text_mkqrqmfw" rows="2" maxlength="700"></textarea>
      <div class="char-counter" id="extrasCounter">0/700</div>
    </label>

    <label>Convidados:</label>
    <div class="guest-slots" id="guestSlots"></div>

    <button type="submit">Criar Atividade</button>
  </form>

  <!-- modal de criação de convidado -->
  <div id="newGuestModal" class="modal hidden">
    <div class="content">
      <h3>Novo Convidado</h3>
      <input id="guestNameInput" placeholder="Nome" />
      <input id="guestCargoInput" placeholder="Cargo" />
      <input id="guestEmpresaInput" placeholder="Empresa" />
      <button id="saveGuestBtn" type="button">Salvar convidado</button>
      <button id="closeGuestModalBtn" type="button">Fechar</button>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const API_URL        = 'https://plain-butterfly-7001.programacao-e50.workers.dev';
    const BOARD_ID       = 9099133664;
    const GUEST_BOARD_ID = 9102764459;

    let selectedGuests = [];
    let guestsToCreate = [];

    async function mondayMutation(query) {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query })
      });
      const j = await res.json();
      if (!res.ok) throw j.errors || j;
      if (j.errors) throw j.errors;
      return j.data;
    }

    function renderSlots() {
      const c = document.getElementById('guestSlots');
      c.innerHTML = '';
      selectedGuests.forEach((g,i) => {
        const d = document.createElement('div');
        d.className = 'guest-slot';
        d.textContent = g.name;
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'remove';
        btn.innerHTML = '&times;';
        btn.onclick = () => { selectedGuests.splice(i,1); renderSlots(); };
        d.appendChild(btn);
        c.appendChild(d);
      });
      if (selectedGuests.length < 6) {
        const b = document.createElement('button');
        b.type = 'button'; b.id = 'addGuestBtn'; b.textContent = '+';
        b.onclick = () => {
          document.getElementById('newGuestModal').classList.remove('hidden');
          ['guestNameInput','guestCargoInput','guestEmpresaInput'].forEach(id=>{
            document.getElementById(id).value = '';
          });
        };
        c.appendChild(b);
      }
    }

    document.getElementById('closeGuestModalBtn').onclick = () => {
      document.getElementById('newGuestModal').classList.add('hidden');
    };
    document.getElementById('saveGuestBtn').onclick = () => {
      const name    = document.getElementById('guestNameInput').value.trim();
      const cargo   = document.getElementById('guestCargoInput').value.trim();
      const empresa = document.getElementById('guestEmpresaInput').value.trim();
      if (!name) return alert('Informe ao menos o nome');
      const guest = { id: null, name, cargo, empresa };
      selectedGuests.push(guest);
      guestsToCreate.push(guest);
      document.getElementById('newGuestModal').classList.add('hidden');
      renderSlots();
    };

    // montar cascata Tema→Subtema
    const subtemasPorTema = {
      "Artes e Cultura": ["Arquitetura","Artes Visuais","Audiovisual","Circo","Cultura Maker","Cultura Popular","Dança","Fotografia","Gastronomia","HQ","Intervenções Urbanas","Literatura","Moda","Música","Patrimônio Imaterial","Teatro"],
      "Comunicação":      ["Comunicação","Creator","Criação de Conteúdo","Design Gráfico/Industrial","Podcast"],
      "Dados e Segurança Digital": ["Análise de Dados","Blockchain","Cibersegurança","Governança de Dados","Investimentos/Criptomoedas","LGPD","NFT","Privacidade","Web3"],
      "Desenvolvimento de Software e Cloud": ["Desenvolvimento de Software e Cloud","Low Code/No Code","Programação de Software"],
      "Diversidade e Inclusão": ["50+","Acessibilidade/PCD","Equidade Racial","LGBTQIAPN+","Mulheres","Neurodivergência","Periferias"],
      "Empreendedorismo e Inovação": ["Ecossistemas de Inovação","Empresa Júnior","Gestão de Comunidades","Inovação Aberta","Internacionalização","Startup","Transformação Digital"],
      "Games e Design":    ["Desenvolvimento de Jogos","e-Sports","Experiência do Usuário (UX/CX)","Gameficação","Interface do Usuário (UI)"],
      "Gente e Gestão":    ["Carreira Profissional","Cultura Organizacional","Desenvolvimento de Times","Formação","RH","Softskills"],
      "Governança":        ["ESG","Governança de Dados","Impacto Social","Legislação","Responsabilidade Social"],
      "Inteligência Artificial, Tecnologias Imersivas e Metaverso": ["Realidade Virtual","Deep Learning","Engenharia de Prompt","Inteligência Artificial","LLM","Machine Learning","Metaverso","Processamento de Linguagem Natural","Realidade Aumentada/Realidade Mista","Visão Computacional"],
      "Investimentos":     ["Captação de Recursos","Investimento em Inovação","Criptomoedas"],
      "Política e Cidadania": ["Cidadania Digital","Direito","Educação","Empregabilidade","Geopolítica","Infância","Mobilidade Urbana","Saúde","Turismo","Urbanismo"],
      "Processos e Técnicas de Mercado": ["Agilidade","Atacado e Varejo","Branding","Canais de Venda","Comportamento do Consumidor","E-commerce","Experiência do Cliente","Marketing","Vendas B2B/B2C"],
      "Setores Tech":      ["Agritech","Cleantech","Construtech","Ecotech","Edutech","Fintech","Foodtech","Govtech","Healthtech","Lawtech","Retailtech","Sportech"],
      "Simulação e Modelagem": ["Corte a Laser","Impressão 3D","Modelagem 3D"],
      "Sustentabilidade":  ["Desenvolvimento Sustentável","Economia Circular","Eficiência Energética","Energia Renovável","Gestão de Resíduos","Logística Reversa","Meio Ambiente","Mudanças Climáticas","ODS"],
      "Tecnologias de Conectividade, Robótica e Computação Avançada": ["5G","6G","Computação Quântica","IoT","Robótica","Sistemas Embarcados"]
    };
    function buildTree(containerId, hiddenInputId) {
      const cont = document.getElementById(containerId),
            hid  = document.getElementById(hiddenInputId);
      cont.innerHTML = '';
      for (let tema in subtemasPorTema) {
        const det = document.createElement('details'),
              sum = document.createElement('summary');
        sum.textContent = tema;
        det.appendChild(sum);
        subtemasPorTema[tema].forEach(sub => {
          const div = document.createElement('div');
          div.className = 'subtema-item';
          div.textContent = sub;
          div.onclick = () => {
            hid.value = `${tema} → ${sub}`;
            cont.querySelectorAll('.subtema-item').forEach(el=>el.style.fontWeight='');
            div.style.fontWeight='bold';
          };
          det.appendChild(div);
        });
        cont.appendChild(det);
      }
    }
    buildTree('temaPrincipalTree','temaPrincipalValue');
    buildTree('temaSecundarioTree','temaSecundarioValue');

    // char counters
    document.getElementById('long_text_mkqr5e1x')
      .addEventListener('input', e => document.getElementById('descCounter').textContent = `${e.target.value.length}/700`);
    document.getElementById('text_mkqrqmfw')
      .addEventListener('input', e => document.getElementById('extrasCounter').textContent = `${e.target.value.length}/700`);

    // toggles
    const fmt = document.getElementById('short_textossh5v4j'),
          daysL = document.getElementById('daysLabel'),
          maxL  = document.getElementById('maxGuestsLabel'),
          rs    = document.getElementById('text_mkqrrpq3'),
          ageL  = document.getElementById('ageRangeLabel'),
          showD = new Set(['Atendimentos','Mentoria','Pitchs','Rodada de negócios','Oficina','Minicurso','Hackathon','Intervenção urbana','Demonstração','Experiência','Visitas/ percursos guiados','Campeonato','Exposição artística','Feira']),
          showM = new Set(['Mentoria','Pitchs','Revisão de portfólio','Rodada de negócios']);
    fmt.addEventListener('change', ()=> {
      daysL.classList.toggle('hidden', !showD.has(fmt.value));
      maxL .classList.toggle('hidden', !showM.has(fmt.value));
    });
    rs.addEventListener('change', ()=> ageL.classList.toggle('hidden', rs.value!=='Sim'));
    fmt.dispatchEvent(new Event('change'));
    rs.dispatchEvent(new Event('change'));

    // submit
    document.getElementById('activityForm').addEventListener('submit', async e=>{
      e.preventDefault();
      // 1) cria convidados novos
      if (guestsToCreate.length) {
        // 1) monta as operações de criação de convidados no Monday
        const parts = guestsToCreate.map((g,i) => {
          const cols = [];
          cols.push(`"text_mkqreer2":{"text":"${g.name.replace(/"/g,'\\"')}"}`);
          if (g.cargo)   cols.push(`"text_mkqry55n":{"text":"${g.cargo.replace(/"/g,'\\"')}"}`);
          if (g.empresa) cols.push(`"text_mkqrghw1":{"text":"${g.empresa.replace(/"/g,'\\"')}"}`);
          const colString = `{${cols.join(',')}}`.replace(/"/g,'\\"');
          return `
            m${i}: create_item(
              board_id: ${GUEST_BOARD_ID},
              item_name: "${g.name.replace(/"/g,'\\"')}",
              column_values: "${colString}"
            ) { id }
          `;
        }).join('\n');

        const batch = `mutation {
          ${parts}
        }`;

        // 2) envia o batch para criar todos os convidados de uma vez
        const res = await mondayMutation(batch);

        // 3) atribui os IDs retornados aos objetos guest e limpa o array
        guestsToCreate.forEach((g,i) => {
          g.id = res[`m${i}`].id;
        });
        guestsToCreate = [];
      }
      // 2) coleta form
      const title  = document.getElementById('text_mkqrhjas').value,
            titleEsc = title.replace(/"/g,'\\"'),
            days     = document.getElementById('short_textb7obn15q').value,
            maxG     = document.getElementById('text_mkqrjadb').value,
            duration = document.getElementById('text_mkqrvnnp').value,
            desc     = document.getElementById('long_text_mkqr5e1x').value,
            extras   = document.getElementById('text_mkqrqmfw').value,
            restr    = document.getElementById('text_mkqrrpq3').value,
            ageRange = document.getElementById('text_mkqrrpq3_range').value,
            pub      = document.getElementById('text_mkqr6nqa').value,
            guestIds = selectedGuests.map(g=>g.id);
      const [temaP, subP=''] = document.getElementById('temaPrincipalValue').value.split(' → '),
            [temaS, subS=''] = document.getElementById('temaSecundarioValue').value.split(' → ');
      // 3) monta cols
      const vals = {
        text_mkqrhjas:      title,
        short_textossh5v4j: fmt.value,
        ...(days && { short_textb7obn15q: days }),
        ...(maxG && { text_mkqrjadb: maxG }),
        text_mkqrvnnp:      duration,
        long_text_mkqr5e1x: desc,
        text_mkqrqmfw:      extras,
        text_mkqrrpq3:      restr==='Sim'? ageRange: restr,
        text_mkqrwawz:      temaP,
        text_mkqrm18v:      subP,
        text_mkqrth67:      temaS,
        text_mkqrfjz3:      subS,
        text_mkqr6nqa:      pub,
        color_mkqr22e3:     { label:'Caixa de Entrada' },
        ...(guestIds.length && {
          board_relation_mkqr6b1t:{
            linkedPulseIds: guestIds.map(id=>({linkedPulseId:id}))
          }
        })
      };
      const colJson = JSON.stringify(vals)
        .replace(/\\/g,'\\\\')
        .replace(/"/g,'\\"')
        .replace(/\n/g,'\\n');
      const mutation = `
        mutation {
          create_item(
            board_id: ${BOARD_ID},
            item_name: "${titleEsc}",
            column_values: "${colJson}"
          ) { id }
        }
      `;
      try {
        const resp = await mondayMutation(mutation);
        alert('Atividade criada! ID: '+resp.create_item.id);
        e.target.reset();
        selectedGuests = [];
        renderSlots();
        buildTree('temaPrincipalTree','temaPrincipalValue');
        buildTree('temaSecundarioTree','temaSecundarioValue');
        fmt.dispatchEvent(new Event('change'));
        document.getElementById('text_mkqrrpq3').dispatchEvent(new Event('change'));
      } catch(err) {
        console.error(err);
        alert('Erro ao criar atividade. Veja console.');
      }
    });

    renderSlots();
  });
  </script>
</body>
</html>
