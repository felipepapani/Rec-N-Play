<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro Completo de Atividade</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; }
    form { display: grid; gap: 1rem; }
    label { display: flex; flex-direction: column; }
    input, textarea, select, button { padding: .4rem; font-size: 1rem; }
    button { width: fit-content; cursor: pointer; }
    .char-counter { font-size: .9rem; color: #666; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>Nova Atividade</h1>
  <form id="activityForm">

    <label>
      Nome da Atividade:
      <input type="text" id="text_mkqrhjas" required>
    </label>

    <label>
      Formato de Atividade:
      <select id="short_textossh5v4j" required>
        <option value="">-- selecione --</option>
        <option>Apresentação artística</option>
        <option>Apresentação de trabalhos</option>
        <option>Atendimentos</option>
        <option>Campeonato</option>
        <option>Contação de História</option>
        <option>Cortejo</option>
        <option>Demonstração</option>
        <option>Desfile de moda</option>
        <option>Exibição audiovisual</option>
        <option>Experiência</option>
        <option>Exposição artística</option>
        <option>Feira</option>
        <option>Hackathon</option>
        <option>Intervenção urbana</option>
        <option>Mentoria</option>
        <option>Mesa redonda</option>
        <option>Minicurso</option>
        <option>Oficina</option>
        <option>Palestra</option>
        <option>Pitchs</option>
        <option>Revisão de portfólio</option>
        <option>Roda de conversa</option>
        <option>Rodada de negócios</option>
        <option>Show</option>
        <option>Talk Show</option>
        <option>Visitas/ percursos guiados</option>
        <option>Workshop</option>
      </select>
    </label>

    <label id="daysLabel" class="hidden">
      Dias (1 a 4):
      <select id="short_textb7obn15q">
        <option value="">-- selecione --</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
      </select>
    </label>

    <label>
      Duração (text_mkqrvnnp):
      <input type="text" id="text_mkqrvnnp">
    </label>

    <label>
      Descrição (max 700 caracteres):
      <textarea id="long_text_mkqr5e1x" rows="3" maxlength="700"></textarea>
      <div class="char-counter" id="descCounter">0/700</div>
    </label>

    <label>
      Tema Principal:
      <select id="text_mkqrwawz">
        <option value="">-- selecione --</option>
        <option>Artes e Cultura</option>
        <option>Comunicação</option>
        <option>Dados e Segurança Digital</option>
        <option>Desenvolvimento de Software e Cloud</option>
        <option>Diversidade e Inclusão</option>
        <option>Empreendedorismo e Inovação</option>
        <option>Games e Design</option>
        <option>Gente e Gestão</option>
        <option>Governança</option>
        <option>Inteligência Artificial, Tecnologias Imersivas e Metaverso</option>
        <option>Investimentos</option>
        <option>Política e Cidadania</option>
        <option>Processos e Técnicas de Mercado</option>
        <option>Setores Tech</option>
        <option>Simulação e Modelagem</option>
        <option>Sustentabilidade</option>
        <option>Tecnologias de Conectividade, Robótica e Computação Avançada</option>
      </select>
    </label>

    <label>
      Tema Secundário:
      <select id="text_mkqrth67">
        <option value="">-- selecione --</option>
        <option>Artes e Cultura</option>
        <option>Comunicação</option>
        <option>Dados e Segurança Digital</option>
        <option>Desenvolvimento de Software e Cloud</option>
        <option>Diversidade e Inclusão</option>
        <option>Empreendedorismo e Inovação</option>
        <option>Games e Design</option>
        <option>Gente e Gestão</option>
        <option>Governança</option>
        <option>Inteligência Artificial, Tecnologias Imersivas e Metaverso</option>
        <option>Investimentos</option>
        <option>Política e Cidadania</option>
        <option>Processos e Técnicas de Mercado</option>
        <option>Setores Tech</option>
        <option>Simulação e Modelagem</option>
        <option>Sustentabilidade</option>
        <option>Tecnologias de Conectividade, Robótica e Computação Avançada</option>
      </select>
    </label>

    <label>
      Subtema Principal:
      <select id="text_mkqrm18v">
        <option value="">-- selecione --</option>
        <option>Artes e Cultura</option>
        <option>Comunicação</option>
        <option>Dados e Segurança Digital</option>
        <option>Desenvolvimento de Software e Cloud</option>
        <option>Diversidade e Inclusão</option>
        <option>Empreendedorismo e Inovação</option>
        <option>Games e Design</option>
        <option>Gente e Gestão</option>
        <option>Governança</option>
        <option>Inteligência Artificial, Tecnologias Imersivas e Metaverso</option>
        <option>Investimentos</option>
        <option>Política e Cidadania</option>
        <option>Processos e Técnicas de Mercado</option>
        <option>Setores Tech</option>
        <option>Simulação e Modelagem</option>
        <option>Sustentabilidade</option>
        <option>Tecnologias de Conectividade, Robótica e Computação Avançada</option>
      </select>
    </label>

    <label>
      Subtema Secundário:
      <select id="text_mkqrfjz3">
        <option value="">-- selecione --</option>
        <option>Artes e Cultura</option>
        <option>Comunicação</option>
        <option>Dados e Segurança Digital</option>
        <option>Desenvolvimento de Software e Cloud</option>
        <option>Diversidade e Inclusão</option>
        <option>Empreendedorismo e Inovação</option>
        <option>Games e Design</option>
        <option>Gente e Gestão</option>
        <option>Governança</option>
        <option>Inteligência Artificial, Tecnologias Imersivas e Metaverso</option>
        <option>Investimentos</option>
        <option>Política e Cidadania</option>
        <option>Processos e Técnicas de Mercado</option>
        <option>Setores Tech</option>
        <option>Simulação e Modelagem</option>
        <option>Sustentabilidade</option>
        <option>Tecnologias de Conectividade, Robótica e Computação Avançada</option>
      </select>
    </label>

    <label>
      público:
      <select id="text_mkqr6nqa">
        <option value="">-- selecione --</option>
        <option>especialista no tema</option>
        <option>geral</option>
        <option>negócios</option>
        <option>infantil</option>
        <option>adolescentes</option>
        <option>apenas mulheres</option>
      </select>
    </label>

    <label id="maxGuestsLabel" class="hidden">
      max público:
      <select id="text_mkqrjadb">
        <option value="">-- selecione --</option>
        <option value="10">10</option>
        <option value="15">15</option>
        <option value="20">20</option>
        <option value="25">25</option>
        <option value="30">30</option>
        <option value="35">35</option>
        <option value="40">40</option>
        <option value="45">45</option>
        <option value="50">50</option>
        <option value="Sem restrição">Sem restrição</option>
      </select>
    </label>

     <!-- Restrição de faixa etária -->
     <label>
        Restrição de faixa etária (text_mkqrrpq3):
        <select id="text_mkqrrpq3" required>
          <option value="">-- selecione --</option>
          <option value="Não">Não</option>
          <option value="Sim">Sim</option>
        </select>
      </label>
      <label id="ageRangeLabel" class="hidden">
        Informe a faixa etária (text_mkqrrpq3_range):
        <input type="text" id="text_mkqrrpq3_range" placeholder="ex: 18-25">
      </label>
  

    <label>
      Informações extras (max 700 caracteres):
      <textarea id="text_mkqrqmfw" rows="2" maxlength="700"></textarea>
      <div class="char-counter" id="extrasCounter">0/700</div>
    </label>

   
    <label>
      Convidados (muliselect):
      <select id="board_relation_mkqr6b1t" multiple size="6"></select>
    </label>

    <button type="submit">Criar Atividade</button>
  </form>

 <<script>
    // Aponte para o seu Worker publicado:
    const API_URL = 'https://plain-butterfly-7001.programacao-e50.workers.dev';

    const BOARD_ID = 9099133664;
    const GUEST_BOARD_ID = 9102764459;

    async function mondayMutation(query) {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query })
      });

      let json;
      try {
        json = await res.json();
      } catch {
        throw { error: 'Resposta inválida do servidor' };
      }

      if (!res.ok) {
        // captura nosso { error: "..."} do Worker ou statusText
        throw { error: json.error || res.statusText };
      }
      if (json.errors) {
        // erros GraphQL
        throw json.errors;
      }
      return json.data;
    }

    async function loadGuests() {
      const q = `query {
        boards(ids: ["${GUEST_BOARD_ID}"]) {
          items_page(limit:100) { items { id name } }
        }
      }`;
      try {
        const data = await mondayMutation(q);
        data.boards[0].items_page.items.forEach(item => {
          const opt = document.createElement('option');
          opt.value = item.id;
          opt.textContent = item.name;
          document.getElementById('board_relation_mkqr6b1t').appendChild(opt);
        });
      } catch (err) {
        // Erros personalizados
        if (Array.isArray(err)) {
          console.error('GraphQL Errors:', err);
          alert('Falha ao carregar convidados:\n' + err.map(e => e.message).join('\n'));
        } else if (err.error) {
          console.error('Worker Error:', err.error);
          alert('Falha ao carregar convidados:\n' + err.error);
        } else {
          console.error('Erro inesperado:', err);
          alert('Erro inesperado ao carregar convidados. Veja o console.');
        }
      }
    }
    loadGuests();

    // Contadores de caracteres
    document.getElementById("long_text_mkqr5e1x").addEventListener("input", e => {
      document.getElementById("descCounter").textContent = `${e.target.value.length}/700`;
    });
    document.getElementById("text_mkqrqmfw").addEventListener("input", e => {
      document.getElementById("extrasCounter").textContent = `${e.target.value.length}/700`;
    });

    const formatSelect = document.getElementById("short_textossh5v4j");
    const daysLabel = document.getElementById("daysLabel");
    const maxGuestsLabel = document.getElementById("maxGuestsLabel");
    const showDays = new Set(["Atendimentos","Mentoria","Pitchs","Rodada de negócios","Oficina","Minicurso","Hackathon","Intervenção urbana","Demonstração","Experiência","Visitas/ percursos guiados","Campeonato","Exposição artística","Feira"]);
    const showMax = new Set(["Mentoria","Pitchs","Revisão de portfólio","Rodada de negócios"]);
    function toggleFields() {
      daysLabel.classList.toggle("hidden", !showDays.has(formatSelect.value));
      maxGuestsLabel.classList.toggle("hidden", !showMax.has(formatSelect.value));
    }
    formatSelect.addEventListener("change", toggleFields);
    toggleFields();

    const restrSelect = document.getElementById("text_mkqrrpq3");
    const ageLabel = document.getElementById("ageRangeLabel");
    function toggleAgeRange() {
      ageLabel.classList.toggle("hidden", restrSelect.value !== "Sim");
    }
    restrSelect.addEventListener("change", toggleAgeRange);
    toggleAgeRange();

    document.getElementById("activityForm").addEventListener("submit", async e => {
      e.preventDefault();
      const title = document.getElementById("text_mkqrhjas").value.replace(/"/g,'\\"');
      const vals = { text_mkqrhjas: title, short_textossh5v4j: formatSelect.value };
      if (showDays.has(formatSelect.value)) vals.short_textb7obn15q = document.getElementById("short_textb7obn15q").value;
      if (showMax.has(formatSelect.value)) vals.text_mkqrjadb = document.getElementById("text_mkqrjadb").value;
      vals.text_mkqrvnnp = document.getElementById("text_mkqrvnnp").value;
      vals.long_text_mkqr5e1x = document.getElementById("long_text_mkqr5e1x").value.replace(/"/g,'\\"');
      vals.text_mkqrqmfw = document.getElementById("text_mkqrqmfw").value.replace(/"/g,'\\"');
      vals.color_mkqr22e3 = { label: "Parado" };
      vals.text_mkqrrpq3 = restrSelect.value;
      if (restrSelect.value === "Sim") vals.text_mkqrrpq3 = document.getElementById("text_mkqrrpq3_range").value.replace(/"/g,'\\"');
      const guests = Array.from(document.getElementById("board_relation_mkqr6b1t").selectedOptions).map(o => parseInt(o.value, 10));
      if (guests.length) vals.board_relation_mkqr6b1t = guests;

      const colJson = JSON.stringify(vals).replace(/"/g,'\\"');
      const mutation = `mutation { create_item(board_id: ${BOARD_ID}, item_name: "${title}", column_values: "${colJson}") { id } }`;
      try {
        const data = await mondayMutation(mutation) ;
        alert("Atividade criada! ID: " + data.create_item.id);
        e.target.reset();
        document.getElementById("descCounter").textContent = "0/700";
        document.getElementById("extrasCounter").textContent = "0/700";
        toggleFields();
        toggleAgeRange();
      } catch (err) {
        console.error("Erro:", err);
        alert("Falha: " + JSON.stringify(err));
      }
    });
  </script>
</body>
</html>
